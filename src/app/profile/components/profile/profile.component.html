<form-message></form-message>
<ng-template sourceListener></ng-template>
<main *bgAwaitPromises="[profileLoaded, emailsLoaded]">
	<div class="topbar">
		<div class="l-containerxaxis">
			<div class="topbar-x-heading l-spacestack">
				{{ profile?.firstName }} {{ profile?.lastName }}
				<div class="l-primarymore">
					<button [routerLink]="['../change-password']" class="button">
						{{
							profile.hasPasswordSet
								? ('Profile.changePass' | translate)
								: ('Profile.setPass' | translate)
						}}
					</button>
					<button [bgPopupMenuTrigger]="editMenu" class="buttonicon buttonicon-secondary" id="trigger2">
						<svg icon="icon_more"></svg>
						<span class="visuallyhidden">{{ 'Profile.more' | translate }}</span>
					</button>
				</div>
			</div>
		</div>
		<bg-popup-menu #editMenu class="menu" id="menu2">
			<div [routerLink]="['/profile/edit']" class="menuitem">
				<svg icon="icon_edit"></svg>
				{{ 'Profile.edit' | translate }}
			</div>
			<div (click)="delete()" class="menuitem">
				<svg icon="icon_remove"></svg>
				{{ 'Profile.delete' | translate }}
			</div>
		</bg-popup-menu>
	</div>

	<div class="l-containerxaxis l-containeryaxis">
		<div class="l-stack u-margin-yaxis3x">
			<p class="u-text-h3-bold u-text-dark2">{{ 'Profile.emails' | translate }}</p>
			<form class="table-x-tr table-x-active" [formGroup]="emailForm.rawControl" (ngSubmit)="submitEmailForm()">
				<div class="forminput forminput-withbutton forminput-light1 u-width-formsmall">
					<bg-formfield-text
						[control]="emailForm.rawControlMap.email"
						[errorMessage]="'Issuer.enterValidEmail' | translate"
						fieldType="email"
						placeholder="{{ 'Profile.emailAddress' | translate }}..."
						inlineButtonText="{{ 'Profile.add' | translate }}"
					>
					</bg-formfield-text>
				</div>
			</form>
		</div>

		<table hlmTable oeb-table-secondary>
			<thead hlmTHead>
				@for (headerRow of table.getHeaderGroups(); track headerRow.id) {
					<tr hlmTr>
						@for (headerCell of headerRow.headers; track headerCell.id) {
							@if (!headerCell.isPlaceholder) {
								<th hlmTh>
									<div
										class="tw-flex tw-flex-row tw-items-center tw-gap-2 [&[data-sortable='true']]:tw-cursor-pointer"
										(click)="headerCell.column.toggleSorting()"
										[attr.data-sortable]="headerCell.column.getCanSort()"
									>
										<div>
											<ng-container
												*flexRender="
													headerCell.column.columnDef.header;
													props: headerCell.getContext();
													let header
												"
											>
												<div [innerHTML]="header"></div>
											</ng-container>
										</div>

										@if (headerCell.column.getIsSorted()) {
											@if (getOrderForHeaderCell(headerCell) === 'asc') {
												<ng-icon hlm size="base" name="lucideChevronUp" />
											} @else {
												<ng-icon hlm size="base" name="lucideChevronDown" />
											}
										} @else if (headerCell.column.getCanSort()) {
											<ng-icon hlm size="base" name="lucideChevronsUpDown" />
										}
									</div>
								</th>
							}
						}
					</tr>
				}
			</thead>
			<tbody hlmTBody>
				@for (row of table.getRowModel().rows; track row.id) {
					<tr hlmTr>
						@for (cell of row.getVisibleCells(); track cell.id) {
							<td hlmTd class="tw-align-middle">
								<ng-container
									*flexRender="cell.column.columnDef.cell; props: cell.getContext(); let cell"
								>
									<div [innerHTML]="cell"></div>
								</ng-container>
							</td>
						}
					</tr>
				}
			</tbody>
		</table>
	</div>
</main>

<ng-template #translateHeaderIDCellTemplate let-context>
	{{ context.header.id | translate | titlecase }}
</ng-template>

<ng-template #emailAddressCellTemplate let-context>
	<div class="tw-flex tw-flex-row tw-gap-4 tw-items-center">
		<p>{{ context.getValue() }}</p>
		@if (context.row.original.primary) {
			<p
				class="tw-px-2 tw-py-1 tw-uppercase tw-bg-green-950 tw-text-white tw-text-xs tw-font-semibold tw-rounded-full"
			>
				{{ 'Profile.primary' | translate }}
			</p>
		}
	</div>
</ng-template>

<ng-template #verifiedStateCellTemplate let-context>
	<div class="tw-flex tw-flex-row tw-gap-4 tw-items-center">
		@if (context.getValue()) {
			<ng-icon
				hlm
				name="lucideCheck"
				size="18px"
				class="tw-bg-green-950 tw-text-white tw-rounded-full tw-size-8 tw-p-0.5"
			/>
			<p>{{ 'Profile.verified' | translate }}</p>
		} @else {
			<ng-icon hlm name="lucideClock" size="22px" />
			<p>{{ 'Profile.pending' | translate }}</p>
		}
	</div>
</ng-template>

<ng-template #badgeActionsCellTemplate let-context>
	@if (!context.row.original.verified) {
		<div>
			<oeb-dropdown
				[trigger]="svgTrigger"
				class="tw-w-min tw-px-0.5 tw-flex tw-items-center tw-justify-center tw-cursor-pointer tw-border tw-border-solid tw-border-purple tw-rounded-[5px]"
				[menuItems]="menuItems()[context.row.index]"
			></oeb-dropdown>
			<ng-template #svgTrigger>
				<svg class="tw-size-6" fill="var(--color-purple)" icon="icon_more"></svg>
				<span class="visuallyhidden">Mehr</span>
			</ng-template>
		</div>
	}
</ng-template>
